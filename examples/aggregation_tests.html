<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.css"/>

  <!-- Necessary includes for LocusZoom.js -->
  <script src="../dist/locuszoom.vendor.min.js" type="text/javascript"></script>
  <script src="../dist/locuszoom.app.js" type="text/javascript"></script>
  <link rel="stylesheet" href="../dist/locuszoom.css" type="text/css"/>

  <!-- Interactive table widget and page-specific code-->
  <script type="application/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script type="application/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/3.5.1/css/tabulator.min.css">
  <script type="text/javascript"
          src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/3.5.1/js/tabulator.min.js"></script>

  <script src="js/raremetal.min.js" type="application/javascript"></script>

  <script type="application/javascript" src="../dist/ext/lz-dynamic-urls.min.js"></script>
  <script src="js/aggregation-test-helpers.js" type="application/javascript"></script>
  <script src="js/aggregation-tests-example-page.js" type="application/javascript"></script>


  <title>LocusZoom.js ~ Aggregation Tests</title>

  <style>
    body {
      background-color: #FAFAFA;
      margin: 0px 20px;
    }

    img {
      max-width: 100%;
      box-sizing: border-box;
    }

    .tabulator {
      font-family: sans-serif;
    }
  </style>

</head>

<body>
<div class="container">

  <div class="row">
    <h1 style="margin-top: 1em;"><strong>LocusZoom.js</strong></h1>

    <h3 style="float: left; color: #777">Aggregation Tests Demonstration</h3>
    <h6 style="float: right;"><a href="../index.html">&lt; return home</a></h6>

    <hr style="clear: both;">

    <p>
      This page demonstrates a mechanism for performing custom aggregation tests interactively, in the web browser.
      The user can compare several different hypotheses, with contextual information to help compare and interpret
      the results.
    </p>

    <p>
      Calculation functionality is provided by <a href="https://github.com/statgen/raremetal.js">raremetal.js</a>.
    </p>
    <hr>
  </div>

  <div class="row">
    <h3>Build your analysis</h3>
    <p>
      Specify the mask(s) and type(s) of aggregation test to run, for all genes in a specified plot region. Use
      CTRL-click to select more than one mask or test.
    </p>
    <div id="widget-aggregation-container">
      <div id="widget-aggregation-builder">Loading...</div>
      <button id="button-aggregation-run" class="button-primary">Run tests</button>
    </div>
  </div>

  <div class="row" id="section-results" style="display:none;">
    <div class="twelve columns">
      <h3>Interactive Plot</h3>
      <p>
        Click on any gene to filter the table of aggregation test results to only those for that gene.
        Click the gene again to unselect and show all aggregation tests across the entire region.

        Each gene/interval can have more than one mask. The entire set of possible results in a given gene/interval is
        summarized by color:
        <span style="color:red">significant</span> /  <span style="color:blue">not significant</span> / <span style="color:grey">no data available</span>.
      </p>
      <div id="lz-plot" class="lz-container-responsive"></div>

      <h3>Table of aggregation test results</h3>
      <div>
        Currently reviewing results for group:
        <span id="label-no-group-selected" style="color: grey;">(all genes in view)</span>
        <span id="label-current-group-selected" style="color: #333333; display: none;"></span>

        <p>Click on a row in the table below to see the variants associated with a specific mask + gene.</p>
      </div>
      <br>
      <button id="download-aggregation" class="button-primary">Download</button><br>
      <div id="results-table-aggregation"></div>

      <h3>Variants in mask <span id="label-mask-selected"></span> </h3>
      <button id="download-variants" class="button-primary">Download</button><br>
      <div id="results-table-variants"></div>
    </div>
  </div>

  <div class="row">
    <footer style="text-align: center;">
      &copy; Copyright 2018 <a href="https://github.com/statgen">The University of Michigan Center for Statistical
      Genetics</a><br>
    </footer>
  </div>
</div>

<script type="application/javascript">
    "use strict";

    ///////////////////////////////////
    // The user must specify a set of aggregation tests they would like to run. The list of
    //  masks is fetched from a server endpoint that returns simple metadata for this region
    var WIDGET_SELECTOR_AGGREGATION = "#widget-aggregation-builder";
    $.ajax("data/aggregation_masks.json") // For demo purposes. A real UI might provide a different way of defining masks.
        .done(function(resp) {
            // Flatten out the masks from all datasets into a single array, then load mask list into builder widget
            var masks = [];
            resp.data.forEach(function(dataset) {
                var set_masks = dataset.masks.filter(function(item) { return item.groupType === "gene"; })
                  .map(function (item) { return [item.id, item.description]; });
                Array.prototype.push.apply(masks, set_masks);
            });
            // Populate the aggregation test builder UI
            window.aggregationBuilder = new AggregationTestBuilder(WIDGET_SELECTOR_AGGREGATION, masks);
        }).fail(function() {
            $("#widget-aggregation-container").text("An error occurred while fetching available masks. Please reload the page.");
        });

    // A bunch of stuff is clickable. Use observables to coordinate all the work of updating the UI
    window.agg_calc_data = Observable(); // aggregation test results
    window.selected_group = Observable(); // { group: string, mask: string, group_display_name: string }, or null

    $("#button-aggregation-run").on("click", function() {
        var valid = aggregationBuilder.validate();
        if (valid) {
            aggregationBuilder.setStatus("");

            // Create the plot and widgets if they don't already exist
            if (!window.plot || !(window.plot instanceof LocusZoom.Plot)) {
                $("#section-results").css("display", "inherit"); // Hide results section until first use
                createDisplayWidgets(window.selected_group);
                setupWidgetListeners(window.plot, window.aggregationTable, window.variantsTable, window.agg_calc_data, window.selected_group);
            }

            // The "define calculations" widget should put the test definitions in a place that the data source
            //  will expect to find them. The widget should define CALCS and MASKS.
            window.plot.applyState({
                aggregation_tests: { masks: aggregationBuilder.getMasks(),  calcs: aggregationBuilder.getCalcs() }
            }).then(function() {
                aggregationBuilder.setStatus("Aggregation calculations complete", { color: "green" });
            }).catch(function() { aggregationBuilder.setStatus("An error occurred while running calculations"); });
        } else {
            aggregationBuilder.setStatus("One or more tests is invalid. Please select at least one mask and at least one test.");
        }
    });

</script>
</body>
</html>
