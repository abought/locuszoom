<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.css"/>

  <!-- Necessary includes for LocusZoom.js -->
  <script src="../dist/locuszoom.vendor.min.js" type="text/javascript"></script>
  <script src="../dist/locuszoom.app.js" type="text/javascript"></script>
  <link rel="stylesheet" href="../dist/locuszoom.css" type="text/css"/>

  <!-- Interactive table widget and page-specific code-->
  <script type="application/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script type="application/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/3.5.1/css/tabulator.min.css">
  <script type="text/javascript"
          src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/3.5.1/js/tabulator.min.js"></script>

  <script src="js/raremetal.min.js" type="application/javascript"></script>

  <script type="application/javascript" src="../dist/ext/lz-dynamic-urls.min.js"></script>
  <script src="js/aggregation-test-helpers.js" type="application/javascript"></script>
  <script src="js/aggregation-tests-example-page.js" type="application/javascript"></script>


  <title>LocusZoom.js ~ Aggregation Tests</title>

  <style>
    body {
      background-color: #FAFAFA;
      margin: 0px 20px;
    }

    img {
      max-width: 100%;
      box-sizing: border-box;
    }

    .tabulator {
      font-family: sans-serif;
    }
  </style>

</head>

<body>
<div class="container">

  <div class="row">
    <h1 style="margin-top: 1em;"><strong>LocusZoom.js</strong></h1>

    <h3 style="float: left; color: #777">Aggregation Tests Demonstration</h3>
    <h6 style="float: right;"><a href="../index.html">&lt; return home</a></h6>

    <hr style="clear: both;">

    <p>
      There are many types of aggregation tests, each with their own unique characteristics. Since it is not always
      possible to provide a single off-the-shelf visualization for every situation, LocusZoom provides a means to
      share plot data with any arbitrary HTML element on the page.
    </p>


    <hr>

    <div class="twelve columns">

      <h3>Build your analysis</h3>
      <p>
        Specify the mask and type of aggregation test to run, for all genes in the visible plot area.
      </p>
      <div id="widget-aggregation-container">
        <div id="widget-aggregation-builder">Loading...</div>
        <button id="button-aggregation-run" class="button-primary">Run tests</button>
      </div>

      <h3>Interactive Plot</h3>
      <p>
        After running aggregation tests, click on any gene below to see a table of aggregation test results, filtered for that gene.
        Click the gene again to unselect and show all results in the table.
      </p>
      <div id="plot" class="lz-container-responsive"></div>
    </div>
  </div>

  <div class="row">
    <div class="twelve columns">
      <h3>Table of aggregation test results</h3>
      <div>
        Currently reviewing results for group:
        <span id="label-no-group-selected" style="color: grey;">(all genes in view)</span>
        <span id="label-current-group-selected" style="color: #333333; display: none;"></span>
      </div>
      <br>
      <button id="download-aggregation" class="button-primary">Download</button><br>
      <div id="results-table-aggregation"></div>


      <h3>Variants in mask <span id="label-mask-selected"></span> </h3>
      <p>
        Click on a row in the table above to see the variants associated with a specific mask + gene.
      </p>
      <div id="results-table-variants"></div>
    </div>
  </div>

  <div class="row">
    <footer style="text-align: center;">
      &copy; Copyright 2018 <a href="https://github.com/statgen">The University of Michigan Center for Statistical
      Genetics</a><br>
    </footer>
  </div>
</div>

<script type="application/javascript">
    ///////////////////////////////////
    // The user must specify a set of aggregation tests they would like to run. The list of
    //  masks is fetched from a server endpoint that returns simple metadata for this region
    var WIDGET_SELECTOR_AGGREGATION = "#widget-aggregation-builder";
    $.ajax("data/aggregation_masks.json")  // `/api/aggregation/metadata` in production
        .done(function(resp) {
            // Flatten out the masks from all datasets into a single array, then load mask list into builder widget
            var masks = [];
            resp.data.forEach(function(dataset) {
                var set_masks = dataset.masks.filter(function(item) { return item.groupType === "gene"; })
                  .map(function (item) { return item.id; });
                Array.prototype.push.apply(masks, set_masks);
            });
            // Populate the aggregation test builder UI
            window.aggregationBuilder = new AggregationTestBuilder(WIDGET_SELECTOR_AGGREGATION, masks);
        }).fail(function() {
            $("#widget-aggregation-container").text("An error occurred while fetching available masks. Please reload the page.");
        });

    /////////////////////////////////////////////////////////
    // Specify the data sources to use, then build the plot
    //   Determine if we're online, based on browser state or presence of an optional query parameter
    var online = !(typeof navigator !== "undefined" && !navigator.onLine);
    if (window.location.search.indexOf("offline") !== -1) {
        online = false;
    }

    var apiBase = "//portaldev.sph.umich.edu/api/v1/";
    var data_sources = new LocusZoom.DataSources()
        .add("assoc", ["AssociationLZ", {
            url: apiBase + "statistic/single/",
            params: { analysis: 42, id_field: "variant" }  // TODO: Important: use an analysis ID that aligns with the data for the portal covariance results
        }])
        .add("ld", ["LDLZ", {url: apiBase + "pair/LD/"}])
        .add("gene", ["GeneLZ", {url: apiBase + "annotation/genes/", params: {source: 2}}])
        .add("aggregation", ["AggregationTestSourceLZ", {url: "data/scorecov.json"}])
        .add("aggregation_genes", ["GeneAggregationConnectorLZ", {sources: {aggregation_ns: "aggregation", gene_ns: "gene"}}])
        .add("recomb", ["RecombLZ", {url: apiBase + "annotation/recomb/results/", params: {source: 15}}])
        .add("constraint", ["GeneConstraintLZ", {url: "//exac.broadinstitute.org/api/constraint"}]);

    // Generate the LocusZoom plot, and reflect the initial plot state in url
    var stateUrlMapping = {chr: "chrom", start: "start", end: "end"};
    // Fetch initial position from the URL, or use some defaults
    var initialState = LocusZoom.ext.DynamicUrls.paramsFromUrl(stateUrlMapping);
    if (!Object.keys(initialState).length) {
        initialState = {chr: 22, start: 21552103, end: 22052103};
    }

    var layout = LocusZoom.Layouts.get("plot", "standard_association", {state: initialState});
    layout = customizePlotLayout(layout);

    window.plot = LocusZoom.populate("#plot", data_sources, layout);

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Changes in the plot can be reflected in the URL, and vice versa (eg browser back button can go back to
    //   a previously viewed region)
    LocusZoom.ext.DynamicUrls.plotUpdatesUrl(plot, stateUrlMapping);
    LocusZoom.ext.DynamicUrls.plotWatchesUrl(plot, stateUrlMapping);

    //////////////////////////////////////////////////////////////////////
    // Draw companion tables to show specific calculation results.
    //
    // Because many things are clickable, this looks like more code than it is. The key concepts are:
    //  1. Allow the plot to tell us when aggregation test results are available.
    //  2. Take that data and update a table
    //  3. If something important gets clicked

    // A bunch of stuff is clickable. Use observables to coordinate all the work of updating the UI
    var agg_calc_data = Observable(); // aggregation test results
    var selected_group = Observable(); // { group: string, mask: string}, or null
    plot.subscribeToData(
        ["aggregation:all"],
        function (data) {
            data = data.aggregation;  // namespaced source in chain.discrete
            // Aggregation calcs return very complex data. Parse it here, once, into reusable helper objects.
            var results = data.results;
            var parsed = raremetal.helpers.parsePortalJSON(data);
            var groups = parsed[0];
            var variants = parsed[1];
            agg_calc_data({
                results: results,
                groups: groups,
                variants: variants
            });
        },
        { discrete: true }
    );

    var TABLE_SELECTOR_AGGREGATION = "#results-table-aggregation";
    var TABLE_SELECTOR_VARIANTS = "#results-table-variants";

    window.variantsTable = new VariantsTableController(TABLE_SELECTOR_VARIANTS, {
        height: 300,
        layout: "fitColumns",
        layoutColumnsOnNewData: true,
        index: "id",
        rowClick: null,
        columns: [
            { title: "Variant", field: "variant" },
            { title: "p-value", field: "pvalue" },
            { title: "Alt allele frequency", field: "altFreq", formatter: _formatSciNotation }
        ],
        placeholder: "No Data Available",
        initialSort: [
            { column: "variant", dir: "asc" }
        ]
    }, plot);

    window.aggregationTable = new AggregationTableController(TABLE_SELECTOR_AGGREGATION, {
        index: "id",
        height: 300,
        layout: "fitColumns",
        layoutColumnsOnNewData: true,
        rowSelected: function(row) {
            selected_group(row.row.data); // notify all observers that value has changed
        },
        rowDeselected: function (row) {
            selected_group(null);
        },
        columns: [
            { title: "Gene", field: "group", formatter: "link", formatterParams: { urlPrefix: "https://exac.broadinstitute.org/gene/" } },  // TODO: readable gene label with exac id for links?
            { title: "Mask", field: "mask", headerFilter: true },
            { title: "# Variants", field: "variant_count" },
            { title: "Test type", field: "calc_type", headerFilter: true, mutator: function (value) { return value.split(",")[0]; } },
            { title: "p-value", field: "pvalue", formatter: _formatSciNotation, sorter: "number" },
            { title: "Statistic", field: "stat", formatter: _formatSciNotation, sorter: "number" }
        ],
        placeholder: "No Data Available",
        initialSort: [
            { column: "pvalue", dir: "asc" }
        ],
        selectable: 1,
        selectablePersistence: false
    }, plot);

    // When results are updated, make sure we are not "drilling down" into a calculation that no longer exists
    agg_calc_data.subscribe(aggregationTable.renderData.bind(aggregationTable));
    agg_calc_data.subscribe(selected_group.bind(null, null));

    // The UI is based on "drilling down" to explore results. If a user selects a group, display stuff
    selected_group.subscribe(function (data) {  // User-friendly label
        var text = '';
        if (data) {
            text = data.mask + " / " + data.group
        }
        $("#label-mask-selected").text(text);
    });
    selected_group.subscribe(function (data) { // "Show me what variants are in a selected group" table
        var calcs = agg_calc_data();

        if (!data || !calcs) { // If no analysis is selected, no analysis should be shown
            variantsTable.renderData([]);
            return;
        }
        // When a group is selected, draw a variants table with information about that group
        var one_group = calcs.groups.getOne(data.mask, data.group);
        var variant_data = calcs.variants.getGroupVariants(one_group.variants);
        variantsTable.renderData(variant_data);
    });


    //////////////////////////////////////////////////////////////
    // Generic UI controls: what to do when buttons are clicked
    $("#download-aggregation").on("click", function() {
        aggregationTable.tableDownloadData("aggregation-data.csv", "csv");
    });

    $("#button-aggregation-run").on("click", function() {
        // The "define calculations" widget should put the test definitions in a place that the data source
        //  will expect to find them. The widget should define TESTS and MASKS.
        var valid = aggregationBuilder.validate();
        if (valid) {
            aggregationBuilder.setStatus();
            plot.applyState({
                aggregation_tests: {
                    masks: aggregationBuilder.getMasks(),
                    calcs: aggregationBuilder.getCalcs()
                }
            }).then(function() { aggregationBuilder.setStatus("Aggregation calculations complete", { color: "green" });
            }).catch(function() { aggregationBuilder.setStatus("An error occurred while running calculations"); });
        } else {
            aggregationBuilder.setStatus("One or more tests is invalid. Please make sure all options are filled in, and all labels are unique.")
        }
    });

</script>
</body>
</html>
